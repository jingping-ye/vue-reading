# 打包构建流程分析

## 1. 入口

打包的入口从`package.json`的`npm`脚本看起，如下：

```bash
"build": "node scripts/build.js",
"build:ssr": "npm run build -- web-runtime-cjs,web-server-renderer",
"build:weex": "npm run build -- weex",
```

分为三个打包的命令，分别是

```bash
# 打包成普通的web版本
npm run build

# 打包成服务端渲染版本
npm run build:ssr

# 打包成weex版本
npm run build:weex
```

后两种打包模式都是在第一个模式的前提上通过传入命令行参数进行的。可以看到的是，主要依赖的是`scripts/build.js`文件。

`build:ssr`传入参数为`--`、`web-runtime-cjs,web-server-renderer`,`build:weex`传入参数为`--`、`weex`

## 2. `scripts/build.js`

- 参照`scripts/build.js`文件

- `scripts/build.js`调用了`scripts/config.js`文件

## 3. `scripts/config.js`文件

> vue 是通过 roll 构建的，顾 config.js 文件里的构建配置是遵循 rollup 的。

### 3.1 构建版本说明

| 构建版本                                  | 说明                                                         |
| ----------------------------------------- | ------------------------------------------------------------ |
| web-runtime-cjs-dev                       | 1. 只包含运行时<br />2. CommonJS模块规范<br />3.             |
| web-runtime-cjs-prod                      |                                                              |
| web-full-cjs-dev                          | 1. 运行时+编译器<br />2. CommonJS模块规范                    |
| web-full-cjs-prod                         |                                                              |
| web-runtime-esm                           | 1. 只包含运行时<br />2. ES Module模块规范                    |
| web-full-esm                              | 1. 运行时+编译器<br />2. ES Module模块规范                   |
| web-full-esm-browser-dev                  | 1. 运行时+编译器<br />2. ES Module模块规范<br />3. 浏览器可以直接引入 |
| web-full-esm-browser-prod                 |                                                              |
| web-runtime-dev                           | 1. 只包含运行时<br />2. UMD模块规范<br />3. 浏览器可以直接引入 |
| web-runtime-prod                          |                                                              |
| web-full-dev                              |                                                              |
| web-full-prod                             |                                                              |
| web-compiler                              | 1. web编译器<br />2. CommonJS规范                            |
| web-compiler-browser                      | 1. web编译器<br />2. UMD规范                                 |
| web-server-renderer-dev                   | 1.服务器渲染<br />2. CommonJS规范                            |
| web-server-renderer-prod                  |                                                              |
| web-server-renderer-basic                 | 1.服务器渲染<br />2. UMD规范                                 |
| web-server-renderer-webpack-server-plugin |                                                              |
| web-server-renderer-webpack-client-plugin |                                                              |
| weex-factory                              | 1. weex运行时                                                |
| weex-framework                            | 1. weex运行时框架<br />2. CommonJS规范                       |
| weex-compiler                             | 1. weex运行时编译器<br />2. CommonJS规范<br />3. weex's webpack使用 |

- 是否包含编译器
   - runtime：只包含运行时
   - full：包含运行时+编译器
- 开发环境
   - dev：开发环境
   - prod: 生产环境
- 模块规范
   - ESM: ES Module规范，供*Rollup 、 Webpack 2*使用
   - web: （无特殊标明）UMD规范,注意有一个版本是`web-full-esm-browser-dev`,是可以直接在浏览器引入的
   - cjs： CommonJS规范，供*webpack*、*Browserify*使用
- 平台
   - web：在web平台上运行
   - browser：浏览器可以直接引入

### 3.2 配置参数说明

| 参数       | 说明                                                        |
| ---------- | ----------------------------------------------------------- |
| entry      | 构建入口js文件                                              |
| dest       | 构建后文件地址                                              |
| format     | 构建的格式;cjs-CommonJS规范\|es-ES Modules规范\|umd-UMD规范 |
| env        | 生产环境还是开发环境 production\|development                |
| banner     | 输出说明                                                    |
| alias      | ?别名                                                       |
| transpile  | 源到源的编译器                                              |
| external   | 额外的插件                                                  |
| moduleName | 模块名称                                                    |
| plugins    | 外部插件                                                    |
| weex       | 是否是`weex`版本                                            |

### 3.3 `运行时`与`运行时+编译器`的区别

没有携带的编译器，也就是说，一些特定的语法无法翻译，因为无法支持。

### 3.4 resolve函数

拼接路径，不同的vue把版本的配置防止在不同的目录下，参考`alias.js`文件